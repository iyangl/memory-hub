# Memory Hub 验收指标（独立于主方案）

> 本文件仅定义“按需上下文方案”的验收口径与观测方法。  
> 不修改 `REDESIGN.md` 主体设计，不约束实现细节，仅作为评估标准与规则参考。

## 1. 目标与边界

- 目标：验证“工作过程中按需取上下文”是否优于“一次性导入大批量上下文”。
- 边界：只评估检索策略，不评估模型能力差异本身。
- 对照组：
  - A 组（Baseline）：会话开始一次性导入全量上下文。
  - B 组（Candidate）：`catalog.read -> memory.read -> 按需补充`。

## 2. 核心验收指标

## 2.1 Token 成本（主指标）

- 指标 1：`topics_ratio = topics_tokens / prompt_tokens_total`
  - 目标：`p50 <= 5%`，`p95 <= 10%`
- 指标 2：`topics_tokens`
  - 硬上限：`topics_tokens <= min(1200, context_window * 8%)`
- 指标 3：`prompt_tokens_total`（与 A 组比较）
  - 目标：B 组相对 A 组中位数下降 `>= 40%`

## 2.2 质量与效果（守门指标）

- 指标 4：任务成功率（测试通过/验收通过）
  - 要求：B 组不低于 A 组超过 `3%`
- 指标 5：错误决策率（因缺上下文导致返工）
  - 目标：B 组低于或等于 A 组
- 指标 6：平均回合数
  - 要求：B 组不高于 A 组超过 `10%`

## 2.3 性能（体验指标）

- 指标 7：首轮响应延迟（TTFR）
  - 目标：B 组 `p95` 相对 A 组下降 `>= 25%`
- 指标 8：检索步数（每任务触发 read/search 次数）
  - 目标：中位数控制在可解释范围（建议 `<= 4`）

## 3. topics.md 体积控制规则

- 保持“索引化一行记录”，不写详细正文。
- 建议单行格式：`topic_id | tags | module | pointers | updated_at`
- 只保留热话题在 `topics.md`，冷话题归档到 `topics_archive.md`。
- 建议归档条件：连续 30 天未命中且非关键约束。
- `topics.md` 只放指针，细节放 `catalog/modules/*.md` 或对应 memory 文件。

## 4. A/B 验收方法

## 4.1 数据集

- 准备同一批任务集（建议 >= 50），覆盖：
  - 低上下文任务（明确单点修改）
  - 高上下文任务（跨模块、带历史决策约束）

## 4.2 对比流程

- 同任务、同模型、同温度参数分别跑 A/B。
- 采用交叉顺序（避免先后顺序偏差）。
- 每个任务记录统一日志字段，最终按 p50/p95 与中位数比较。

## 4.3 判定条件（建议）

- 必须同时满足：
  - `prompt_tokens_total`：B 组较 A 组下降 `>= 40%`
  - `TTFR p95`：B 组较 A 组下降 `>= 25%`
  - 任务成功率：B 组不劣于 A 组超过 `3%`

## 5. 可观测性与落地记录

- 每次任务至少记录：
  - `run_id, task_id, strategy(A/B), model`
  - `topics_tokens, prompt_tokens_total, completion_tokens`
  - `ttfr_ms, total_latency_ms`
  - `task_success, turns, fallback_search_used`
- 若平台无原生 token usage，使用同一 tokenizer 估算 A/B 两组（保证可比性）。

## 6. Skill 触发规则（建议稿）

> 以下为规则参考，可落到 `AGENTS/CLAUDE` 规则文件，不强制绑定实现。

1. `task_received`：先判断任务类型（`quick_fix / scoped_change / feature_work`）。
2. 若 `quick_fix` 且目标文件明确：可跳过 `catalog.read topics`。
3. 否则：先读 `catalog.read topics`（受 token 预算约束）。
4. 模块不明确：触发 `catalog.read <module>`。
5. topics 未命中：触发 `memory.search <query>` 兜底。
6. 修改代码或做设计决策前：至少加载 1 个相关 `memory.read`。
7. 产生“代码读不到的新知识”：触发 `memory.write`。
8. 发生文件增删改路径变化：标记 `catalog_dirty = true`。
9. `task_end`：若 `catalog_dirty`，执行 `catalog.update`；若发生写入或更新，执行 `catalog.repair`。

## 7. 周期复盘机制

- 每周产出一次简报：指标趋势、失败样本、触发规则误判案例。
- 连续两周不达标时，优先调整触发规则，再调整数据结构。

